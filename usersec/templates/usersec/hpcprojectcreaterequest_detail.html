{% extends 'base.html' %}

{% load common %}

{% block content %}

<h2 class="mt-5">
  Request Project
  <span class="float-end">
    {% if admin %}
      {% include "usersec/modules/request_buttons_admin.html" %}
    {% else %}
      {% include "usersec/modules/request_buttons_user.html" %}
    {% endif %}
  </span>
</h2>

{% if admin %}
<div class="row mt-4" id="folder-name-warning">
  <div class="col-12 alert alert-warning">
    Note that you explicitly need to set the POSIX project name and the folder path for the project before approval.
    <ul>
      <li class="fw-bold" id="name-not-submitted">POSIX name not yet submitted</li>
      <li class="fw-bold" id="folder-not-submitted">Folder path not yet submitted</li>
    </ul>
  </div>
</div>
{% else %}
  {% include "usersec/modules/request_status_card.html" %}
{% endif %}

<div class="row mt-4">
  <div class="col-sm-7">
    <dl class="row">    
      {% include "usersec/modules/resources_requested.html" with object=object %}

      <dt class="col-sm-6">Requested Name</dt>
      <dd class="col-sm-6">{{ object.name_requested }}</dd>

      {% if admin %}
      <dt class="col-sm-6">Requester</dt>
      <dd class="col-sm-6">
        {{ object.requester.name }}
        <span class="small fw-light">({{ object.requester.hpcuser_user.first.username }})</span>
      </dd>

      <dt class="col-sm-6">Associated Group</dt>
      <dd class="col-sm-6">
        AG {{ object.group.name.capitalize }}
        &mdash; {{ object.group.owner.user.name }}
        <span class="fw-light">({{ object.group.owner.username }})</span>
      </dd>

      <dt class="col-sm-6">
        POSIX Name
        <span class="text-success" id="name-submitted-icon">
          <i class="iconify" data-icon="mdi:check-bold" class="text-success"></i>
        </span>
      </dt>
      <dd class="col-sm-6">
        <div class="input-group">
          <input
                type="text"
                class="form-control"
                id="set-name-value"
                placeholder="{{ hpc_project_name_suggestion }}"
                value="{{ hpc_project_name_suggestion }}"
                aria-label="Set Project Name"
                aria-describedby="set-values-button set-name-server-response"
                required>
          <div id="set-name-response"></div>
        </div>
      </dd>

      <dt class="col-sm-6">
        Folders
        <span class="text-success" id="folder-submitted-icon">
          <i class="iconify" data-icon="mdi:check-bold" class="text-success"></i>
        </span>
      </dt>
      <dd class="col-sm-6">
        <h6><strong>Tier 1</strong></h6>
        <div class="input-group">
          <span class="input-group-text">Work</span>
          <input
                type="text"
                class="form-control"
                id="set-folder-tier1_work-value"
                placeholder="{{ hpc_project_path_suggestion_tier1_work }}"
                value="{{ hpc_project_path_suggestion_tier1_work }}"
                aria-label="Set Folder"
                aria-describedby="set-values-button set-folder-tier1_work-response"
                required>
          <div id="set-folder-tier1_work-response"></div>
        </div>
        <div class="input-group">
          <span class="input-group-text">Scratch</span>
          <input
                type="text"
                class="form-control"
                id="set-folder-tier1_scratch-value"
                placeholder="{{ hpc_project_path_suggestion_tier1_scratch }}"
                value="{{ hpc_project_path_suggestion_tier1_scratch }}"
                aria-label="Set Folder"
                aria-describedby="set-values-button set-folder-tier1_scratch-response"
                required>
          <div id="set-folder-tier1_scratch-response"></div>
        </div>
        <h6 class="mt-3"><strong>Tier 2</strong></h6>
        <div class="input-group">
          <span class="input-group-text">Unmirrored</span>
          <input
                type="text"
                class="form-control"
                id="set-folder-tier2_unmirrored-value"
                placeholder="{{ hpc_project_path_suggestion_tier2_unmirrored }}"
                value="{{ hpc_project_path_suggestion_tier2_unmirrored }}"
                aria-label="Set Folder"
                aria-describedby="set-values-button set-folder-tier2_unmirrored-response"
                required>
          <div id="set-folder-tier2_unmirrored-response"></div>
        </div>
        <div class="input-group">
          <span class="input-group-text">Mirrored</span>
          <input
                type="text"
                class="form-control"
                id="set-folder-tier2_mirrored-value"
                placeholder="{{ hpc_project_path_suggestion_tier2_mirrored }}"
                value="{{ hpc_project_path_suggestion_tier2_mirrored }}"
                aria-label="Set Folder"
                aria-describedby="set-values-button set-folder-tier2_mirrored-response"
                required>
          <div id="set-folder-tier2_mirrored-response"></div>
        </div>
        <div>
          <button class="btn btn-outline-secondary" type="button" id="set-values-button">Submit</button>
        </div>          
      </dd>
      {% endif %}

      <dt class="col-sm-6">Delegate</dt>
      <dd class="col-sm-6">
        {% if object.delegate %}
          {{ object.delegate.user.name }}
          <span class="fw-light">({{ object.delegate.username }}, AG {{ object.delegate.primary_group.name }})</span>
        {% else %}
          <em class="text-muted">No delegate.</em>
        {% endif %}
      </dd>

      <dt class="col-sm-6">Members</dt>
      <dd class="col-sm-6">
        <ul class="list-unstyled">
          {% for member in object.members.all %}
            <li>
              {{ member.user.name }} <span class="fw-light">({{ member.username }}, AG {{ member.primary_group.name }})</span>
            </li>
          {% endfor %}
        </ul>
      </dd>

      <dt class="col-sm-6">Expiration</dt>
      <dd class="col-sm-6">{{ object.expiration|date:"Y-m-d" }}</dd>
    </dl>
  </div>
  <div class="col-sm-5">
    {% include "usersec/modules/comments.html" %}
  </div>
</div>
{% endblock content %}

{% block inline_javascript %}
  {% if admin %}
  <script type="text/javascript">
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          // Does this cookie string begin with the name we want?
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    function checkSubmissionStatus() {
      const csrftoken = getCookie('csrftoken');
      $("#folder-submitted-icon").hide();
      $("#name-submitted-icon").hide();
      $("#folder-name-warning").hide();
      $.ajax({
        url: "{% url 'adminsec:api-hpcprojectcreaterequest-retrieveupdate' object.uuid %}",
        method: "GET",
        headers: {'X-CSRFToken': csrftoken},
        mode: 'same-origin', // Do not send CSRF token to another domain.
        success: function(data) {
          let folders = false;
          if (data.folders) {
            folders = data.folders['tier1_work'] &&
              data.folders['tier1_scratch'] &&
              data.folders['tier2_unmirrored'] &&
              data.folders['tier2_mirrored']
          }
          if (data.name && folders) {
            $("#folder-submitted-icon").show();
            $("#name-submitted-icon").show();
          } else {
            $("#folder-name-warning").show();
            if (data.name) {
              $("#name-not-submitted").hide();
              $("#name-submitted-icon").show();
            }
            if (folders) {
              $("#folder-not-submitted").hide();
              $("#folder-submitted-icon").show();
            }
          }
        },
        error: function(jqXHR, textStatus, errorThrown) {
          console.error(jqXHR);
        }
      });
    }

    $(document).ready(function() {
      checkSubmissionStatus();

      $("#set-values-button").click(function() {
        const csrftoken = getCookie('csrftoken');
        data = {
            csrfmiddlewaretoken: csrftoken,
            name: $("#set-name-value").val(),
            folders: {
              tier1_work: $("#set-folder-tier1_work-value").val(),
              tier1_scratch: $("#set-folder-tier1_scratch-value").val(),
              tier2_unmirrored: $("#set-folder-tier2_unmirrored-value").val(),
              tier2_mirrored: $("#set-folder-tier2_mirrored-value").val()
            }
          }
        $.ajax({
          url: "{% url 'adminsec:api-hpcprojectcreaterequest-retrieveupdate' object.uuid %}",
          method: "PATCH",
          headers: {'X-CSRFToken': csrftoken, "Content-Type": "application/json"},
          mode: 'same-origin', // Do not send CSRF token to another domain.
          data: JSON.stringify(data),
          success: function(data) {
            $("#set-name-value").removeClass().addClass("form-control is-valid");
            $("#set-name-response").text("Project name has been set").removeClass().addClass("valid-feedback");
            for (const key in data.folders) {
              $(`#set-folder-${key}-value`).removeClass().addClass("form-control is-valid");
              $(`#set-folder-${key}-response`).text('Folder has been set.').removeClass().addClass("valid-feedback");
            }
            checkSubmissionStatus();
          },
          error: function(jqXHR, textStatus, errorThrown) {
            $("#set-name-value").removeClass().addClass("form-control is-invalid");
            $("#set-name-response").text(jqXHR.responseJSON.name).removeClass().addClass("invalid-feedback");
            for (const key in jqXHR.responseJSON) {
              $(`#set-folder-${key}-value`).removeClass().addClass("form-control is-invalid");
              $(`#set-folder-${key}-response`).text(jqXHR.responseJSON[key]).removeClass().addClass("invalid-feedback");
            }
          }
        });
      });
    })
  </script>
  {% endif %}
{% endblock inline_javascript %}
